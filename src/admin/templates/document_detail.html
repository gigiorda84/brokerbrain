{% extends "base.html" %}
{% block title %}Documento {{ document_id[:8] if document_id else '?' }} - BrokerBot Admin{% endblock %}

{% block content %}
{% if document is none %}
<div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
    <p class="text-red-800 text-lg font-semibold">Documento non trovato</p>
    <p class="text-red-600 text-sm mt-2">ID: <code>{{ document_id }}</code></p>
    <a href="/admin/sessions" class="mt-4 inline-block text-blue-600 hover:text-blue-800 text-sm">Torna alle sessioni</a>
</div>
{% else %}

<!-- Breadcrumb -->
<div class="flex items-center space-x-2 text-sm text-gray-500 mb-6">
    <a href="/admin/sessions" class="hover:text-blue-600">Sessioni</a>
    <span>&rsaquo;</span>
    <a href="/admin/session/{{ document.session_id }}" class="hover:text-blue-600">{{ document.session_id|string|truncate(8, True, '') }}</a>
    <span>&rsaquo;</span>
    <span class="text-gray-800">Documento</span>
</div>

<div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Documento</h2>
    <a href="/admin/session/{{ document.session_id }}" class="text-sm text-blue-600 hover:text-blue-800">Torna alla sessione</a>
</div>

<!-- Metadata cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-xs text-gray-500 uppercase">Tipo documento</p>
        <p class="text-sm font-semibold mt-1">{{ document.doc_type or '-' }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-xs text-gray-500 uppercase">MIME type</p>
        <p class="text-sm font-mono mt-1">{{ document.mime_type or '-' }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-xs text-gray-500 uppercase">Dimensione</p>
        <p class="text-sm font-semibold mt-1">
            {% if document.file_size_bytes %}
                {% if document.file_size_bytes > 1048576 %}
                    {{ '%.1f' | format(document.file_size_bytes / 1048576) }} MB
                {% elif document.file_size_bytes > 1024 %}
                    {{ '%.1f' | format(document.file_size_bytes / 1024) }} KB
                {% else %}
                    {{ document.file_size_bytes }} B
                {% endif %}
            {% else %}-{% endif %}
        </p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-xs text-gray-500 uppercase">Confidenza globale</p>
        <p class="text-sm font-semibold mt-1
            {% if document.overall_confidence is not none %}
                {% if document.overall_confidence < 0.7 %}text-red-600
                {% elif document.overall_confidence < 0.9 %}text-yellow-600
                {% else %}text-green-600{% endif %}
            {% endif %}">
            {{ document.overall_confidence|confidence if document.overall_confidence is not none else '-' }}
        </p>
    </div>
</div>

<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-xs text-gray-500 uppercase">Modello OCR</p>
        <p class="text-sm font-mono mt-1">{{ document.processing_model or '-' }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-xs text-gray-500 uppercase">Tempo di elaborazione</p>
        <p class="text-sm font-semibold mt-1">{{ '%dms' % document.processing_time_ms if document.processing_time_ms else '-' }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-xs text-gray-500 uppercase">Caricato il</p>
        <p class="text-sm mt-1">{{ document.created_at|datetime }}</p>
    </div>
</div>

<!-- Per-field confidence scores -->
{% if document.confidence_scores %}
<div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Confidenza per campo</h3>
    </div>
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Campo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confidenza</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Barra</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for field_name, conf in document.confidence_scores.items() %}
            <tr>
                <td class="px-6 py-3 text-sm font-medium text-gray-800">{{ field_name }}</td>
                <td class="px-6 py-3 text-sm
                    {% if conf < 0.7 %}text-red-600 font-medium
                    {% elif conf < 0.9 %}text-yellow-600
                    {% else %}text-green-600{% endif %}">
                    {{ '%.0f' | format(conf * 100) }}%
                </td>
                <td class="px-6 py-3">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full
                            {% if conf < 0.7 %}bg-red-500
                            {% elif conf < 0.9 %}bg-yellow-500
                            {% else %}bg-green-500{% endif %}"
                            style="width: {{ (conf * 100)|int }}%"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- OCR extracted values -->
{% if document.ocr_result %}
<div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Valori estratti (OCR)</h3>
    </div>
    {% if document.ocr_result is mapping %}
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Campo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valore</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for key, val in document.ocr_result.items() %}
            <tr>
                <td class="px-6 py-3 text-sm font-medium text-gray-800">{{ key }}</td>
                <td class="px-6 py-3 text-sm text-gray-600 font-mono">{{ val }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <details class="px-6 py-3 border-t border-gray-100">
        <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-700">
            JSON grezzo completo
        </summary>
        <pre class="mt-2 text-xs bg-gray-50 rounded p-3 overflow-x-auto max-h-96 overflow-y-auto">{{ document.ocr_result | tojson(indent=2) }}</pre>
    </details>
</div>
{% else %}
<div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
    <p class="text-gray-600">Nessun risultato OCR disponibile per questo documento.</p>
</div>
{% endif %}

{% endif %}
{% endblock %}
